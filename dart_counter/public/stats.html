<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statystyki Gracza</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115; --panel: #161920; --accent: #ff4a4a; --text: #ffffff;
            --text-sub: #8b9bb4; --green: #2ecc71; --blue: #3498db; --purple: #9b59b6; --gold: #f1c40f;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        .history-panel { width: 340px; background: var(--panel); border-left: 1px solid #333; display: flex; flex-direction: column; height: 100%; }
        .h-header { padding: 20px; border-bottom: 1px solid #333; font-weight: 900; letter-spacing: 1px; color: var(--text-sub); }
        .h-list { flex: 1; overflow-y: auto; padding: 10px; }
        .h-item { background: #111; border: 1px solid #333; padding: 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; cursor: pointer; }
        .h-item:hover { border-color: var(--accent); background: #1a1a1a; }
        .h-res { font-weight: 900; font-size: 1.2rem; width: 30px; text-align: center; }
        .win { color: var(--green); } .loss { color: var(--accent); }
        .h-details { font-size: 0.8rem; color: #888; flex: 1; margin-left: 10px; }
        .h-avg { background: #222; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: var(--blue); font-weight: bold; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; position:relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative; z-index: 10; }
        
        .user-switch-container { position: relative; }
        .user-title { font-size: 2.2rem; font-weight: 900; text-transform: uppercase; margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .user-title::after { content: '▼'; font-size: 1rem; color: var(--text-sub); }
        .user-dropdown { 
            position: absolute; top: 100%; left: 0; background: var(--panel); border: 1px solid #333; 
            border-radius: 12px; padding: 10px; min-width: 200px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        .user-dropdown.show { display: flex; flex-direction: column; }
        .ud-item { padding: 10px; cursor: pointer; color: #aaa; font-weight: bold; border-radius: 6px; transition: 0.2s; }
        .ud-item:hover { background: #333; color: white; }

        .back-btn { background: #333; color: white; padding: 10px 20px; border-radius: 50px; text-decoration: none; font-weight: bold; transition: 0.2s; }
        .back-btn:hover { background: var(--accent); }

        .kpi-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px; }
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #2a2a2e; position: relative; overflow: hidden; }
        .card h3 { margin: 0; font-size: 0.6rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .card .value { font-size: 1.5rem; font-weight: 900; margin-top: 5px; color: white; }
        .card .sub { font-size: 0.7rem; color: #666; margin-top: 2px; }
        .c-avg .value { color: var(--accent); } .c-f9 .value { color: var(--blue); }
        .c-co .value { color: var(--green); } .c-win .value { color: var(--purple); }
        .c-best .value { color: var(--gold); } .c-hi .value { color: white; } .c-turn .value { color: #e91e63; }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; min-height: 350px; }
        .chart-card { background: var(--panel); padding: 20px; border-radius: 16px; border: 1px solid #2a2a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .chart-title { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: var(--text-sub); width:100%; text-align:left; }
        .canvas-container { flex: 1; position: relative; width: 100%; }
        
        #heatmap-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--panel); width: 90%; max-width: 500px; padding: 30px; border-radius: 16px; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .m-title { text-align: center; font-size: 1.5rem; font-weight: 900; margin-bottom: 5px; color:white; }
        .m-sub { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; }
        .stats-table th { color: var(--text-sub); font-size: 0.7rem; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .stats-table td { color: white; text-align: center; padding: 12px 0; border-bottom: 1px solid #222; font-weight: 600; font-size: 1.1rem; }
        .m-close { width: 100%; padding: 15px; background: var(--accent); border: none; font-weight: bold; font-size: 1rem; border-radius: 8px; margin-top: 20px; cursor: pointer; }

        @media (max-width: 1200px) {
            body { flex-direction: column; overflow: auto; }
            .history-panel { width: 100%; height: auto; max-height: 400px; }
            .kpi-grid { grid-template-columns: 1fr 1fr 1fr; }
            .charts-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="top-bar">
            <div class="user-switch-container">
                <h1 class="user-title" id="u-name" onclick="toggleDropdown()">...</h1>
                <div id="user-dropdown" class="user-dropdown"></div>
            </div>
            <a href="/" class="back-btn">← WRÓĆ DO GRY</a>
        </div>
        <div class="kpi-grid">
            <div class="card c-avg"><h3>Średnia</h3><div class="value" id="k-avg">0.00</div><div class="sub">Ogólna</div></div>
            <div class="card c-f9"><h3>First 9</h3><div class="value" id="k-f9">0.00</div><div class="sub">Start</div></div>
            <div class="card c-co"><h3>Checkout</h3><div class="value" id="k-co">0%</div><div class="sub">Skuteczność</div></div>
            <div class="card c-best"><h3>Best Leg</h3><div class="value" id="k-best">-</div><div class="sub">Lotki</div></div>
            <div class="card c-hi"><h3>Hi-Check</h3><div class="value" id="k-hi">0</div><div class="sub">Zamek</div></div>
            <div class="card c-turn"><h3>Hi-Turn</h3><div class="value" id="k-turn">0</div><div class="sub">Wynik</div></div>
            <div class="card c-win"><h3>Win Rate</h3><div class="value" id="k-win">0%</div><div class="sub" id="k-games">Mecze: 0</div></div>
        </div>
        <div class="charts-row">
            <div class="chart-card"><div class="chart-title">HEATMAPA (Tylko tryb tarczy)</div><div id="heatmap-container"></div></div>
            <div class="chart-card"><div class="chart-title">FORMA (Ostatnie 20 meczy)</div><div class="canvas-container"><canvas id="trendChart"></canvas></div></div>
            <div class="chart-card"><div class="chart-title">SCORING (Rozkład rzutów)</div><div class="canvas-container"><canvas id="distChart"></canvas></div></div>
        </div>
    </div>
    <div class="history-panel">
        <div class="h-header">HISTORIA</div>
        <div class="h-list" id="h-list"></div>
    </div>
    <div id="match-modal" class="modal-overlay" onclick="if(event.target.id==='match-modal')this.style.display='none'">
        <div class="modal-box">
            <div class="m-title">RAPORT MECZOWY</div>
            <div class="m-sub" id="m-sub">...</div>
            <table class="stats-table"><thead><tr><th>STATYSTYKA</th><th id="m-p1">JA</th><th id="m-p2">RYWAL</th></tr></thead><tbody id="m-body"></tbody></table>
            <button class="m-close" onclick="document.getElementById('match-modal').style.display='none'">ZAMKNIJ</button>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUserId = new URLSearchParams(window.location.search).get('user');
        if (!currentUserId) window.location.href = "/";
        
        socket.on('connect', () => {
            socket.emit('init_stats_page', currentUserId);
        });

        socket.on('users_list', (users) => {
            const drop = document.getElementById('user-dropdown');
            drop.innerHTML = "";
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'ud-item';
                div.innerText = u.name;
                div.onclick = () => { window.location.href = `/stats?user=${u.id}`; };
                drop.appendChild(div);
            });
        });

        function toggleDropdown() {
            const d = document.getElementById('user-dropdown');
            d.classList.toggle('show');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.user-title')) {
                const d = document.getElementById('user-dropdown');
                if (d && d.classList.contains('show')) d.classList.remove('show');
            }
        }

        socket.on('full_stats_data', (data) => {
            if (!data.user) return;
            document.getElementById('u-name').innerText = data.user;
            document.getElementById('k-avg').innerText = data.summary.avg;
            document.getElementById('k-f9').innerText = data.summary.first9;
            document.getElementById('k-co').innerText = data.summary.coPct + "%";
            document.getElementById('k-win').innerText = data.summary.winRate + "%";
            document.getElementById('k-best').innerText = data.summary.bestLeg;
            document.getElementById('k-hi').innerText = data.summary.hiOut;
            document.getElementById('k-turn').innerText = data.summary.hiTurn;
            document.getElementById('k-games').innerText = `W: ${data.summary.wins} / L: ${data.summary.games - data.summary.wins}`;
            const hList = document.getElementById('h-list'); hList.innerHTML = "";
            data.history.forEach(m => {
                const div = document.createElement('div'); div.className = 'h-item';
                div.onclick = () => socket.emit('get_match_details', m.id);
                div.innerHTML = `<div class="h-res ${m.result==='W'?'win':'loss'}">${m.result}</div><div class="h-details"><div style="font-weight:bold;color:#ddd">vs ${m.rival}</div><div>${new Date(m.date).toLocaleDateString()} | ${m.score}</div></div><div class="h-avg">AVG ${m.avg}</div>`;
                hList.appendChild(div);
            });
            renderTrendChart(data.charts); renderDistChart(data.distribution);
            renderHeatmap(data.heatmap);
        });
        socket.on('history_match_details', (m) => {
            const p1 = m.players[0]; const p2 = m.players[1];
            document.getElementById('m-sub').innerText = `${new Date(m.date).toLocaleString()} | Wynik: ${m.scoreStr}`;
            document.getElementById('m-p1').innerText = p1.name; document.getElementById('m-p2').innerText = p2.name;
            const pct = (s) => s.doublesThrown===0 ? "0%" : ((s.doublesHit/s.doublesThrown)*100).toFixed(1)+"%";
            document.getElementById('m-body').innerHTML = `
                <tr><td>ŚREDNIA</td><td>${p1.avg}</td><td>${p2.avg}</td></tr>
                <tr><td>FIRST 9</td><td>${p1.first9Avg || '-'}</td><td>${p2.first9Avg || '-'}</td></tr>
                <tr><td>SCORING AVG</td><td>${p1.scoringAvg || p1.avg}</td><td>${p2.scoringAvg || p2.avg}</td></tr>
                <tr><td>CHECKOUT</td><td>${pct(p1.stats)}</td><td>${pct(p2.stats)}</td></tr>
                <tr><td>140+</td><td>${p1.stats.score140}</td><td>${p2.stats.score140}</td></tr>
                <tr><td>180</td><td>${p1.stats.score180}</td><td>${p2.stats.score180}</td></tr>
                <tr><td>HI-OUT</td><td>${p1.stats.highestCheckout}</td><td>${p2.stats.highestCheckout}</td></tr>
                <tr><td>RZUTY</td><td>${p1.dartsThrown}</td><td>${p2.dartsThrown}</td></tr>
            `;
            document.getElementById('match-modal').style.display = 'flex';
        });
        let trendChartRef, distChartRef;
        function renderTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(trendChartRef) trendChartRef.destroy();
            const grad = ctx.createLinearGradient(0,0,0,400); grad.addColorStop(0,'rgba(255, 74, 74, 0.5)'); grad.addColorStop(1,'rgba(255, 74, 74, 0)');
            trendChartRef = new Chart(ctx, { type: 'line', data: { labels: data.labels, datasets: [
                { label: 'AVG', data: data.avg, borderColor: '#ff4a4a', backgroundColor: grad, fill:true, tension:0.4 },
                { label: 'Scoring Avg', data: data.scoring, borderColor: '#e91e63', borderDash:[5,5], tension:0.4 },
                { label: 'First 9', data: data.first9, borderColor: '#3498db', borderDash:[2,2], tension:0.4 }
            ] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'white'}}}, scales:{y:{grid:{color:'#333'},ticks:{color:'#888'}}, x:{display:false}} } });
        }
        function renderDistChart(data) {
            const ctx = document.getElementById('distChart').getContext('2d');
            if(distChartRef) distChartRef.destroy();
            distChartRef = new Chart(ctx, { type: 'bar', data: { labels: ['0+', '20+', '40+', '60+', '80+', '100+', '120+', '140+', '180'], datasets: [{ label:'Ilość', data:data, backgroundColor:['#444','#555','#666','#777','#3498db','#2ecc71','#2ecc71','#9b59b6','#f1c40f'], borderRadius:4 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'#333'},ticks:{color:'#888'}}, x:{ticks:{color:'white', font:{size:9}}}} } });
        }
        function renderHeatmap(heatmapData) {
            const container = document.getElementById('heatmap-container');
            container.innerHTML = "";
            const ns = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(ns, "svg");
            svg.setAttribute("viewBox", "-200 -200 400 400");
            svg.setAttribute("width", "300"); svg.setAttribute("height", "300");
            const nums = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
            
            // POPRAWIONE PROMIENIE (ZGODNE Z INDEX.HTML)
            const radii = [0, 6.35, 15.9, 99, 109, 162, 170]; 
            
            let maxHits = 0;
            for(let key in heatmapData) { if(heatmapData[key] > maxHits) maxHits = heatmapData[key]; }

            const getColor = (hits) => {
                if(!hits) return null;
                const ratio = hits / maxHits;
                if(ratio < 0.2) return `rgba(46, 204, 113, ${0.3 + ratio})`; 
                if(ratio < 0.5) return `rgba(241, 196, 15, ${0.4 + ratio})`;
                return `rgba(231, 76, 60, ${0.5 + ratio})`;
            };

            for(let i=0; i<20; i++) {
                const startAngle = (i * 18 - 9) * Math.PI/180;
                const endAngle = ((i+1) * 18 - 9) * Math.PI/180;
                const makePath = (rIn, rOut, idPrefix) => {
                    const x1 = Math.sin(startAngle)*rIn; const y1 = -Math.cos(startAngle)*rIn;
                    const x2 = Math.sin(endAngle)*rIn;   const y2 = -Math.cos(endAngle)*rIn;
                    const x3 = Math.sin(endAngle)*rOut;  const y3 = -Math.cos(endAngle)*rOut;
                    const x4 = Math.sin(startAngle)*rOut;const y4 = -Math.cos(startAngle)*rOut;
                    const d = `M ${x1} ${y1} L ${x4} ${y4} A ${rOut} ${rOut} 0 0 1 ${x3} ${y3} L ${x2} ${y2} A ${rIn} ${rIn} 0 0 0 ${x1} ${y1} Z`;
                    const p = document.createElementNS(ns, "path");
                    p.setAttribute("d", d);
                    let val = nums[i];
                    let pureId = val.toString();
                    if (idPrefix === 'D') pureId = "D"+val;
                    else if (idPrefix === 'T') pureId = "T"+val;
                    
                    let baseFill = (i%2===0) ? "#111" : "#222"; 
                    if(idPrefix === 'D' || idPrefix === 'T') baseFill = (i%2===0) ? "#333" : "#444";
                    
                    const heatColor = getColor(heatmapData[pureId]);
                    p.setAttribute("fill", heatColor || baseFill);
                    p.setAttribute("stroke", "#333");
                    p.setAttribute("stroke-width", "0.5");
                    svg.appendChild(p);
                };
                
                makePath(radii[5], radii[6], 'D');
                makePath(radii[4], radii[5], 'S');
                makePath(radii[3], radii[4], 'T');
                makePath(radii[2], radii[3], 'S');
            }
            const makeCircle = (r, id, defColor) => {
                const c = document.createElementNS(ns, "circle");
                c.setAttribute("r", r); 
                const heatColor = getColor(heatmapData[id]);
                c.setAttribute("fill", heatColor || defColor);
                c.setAttribute("stroke", "#333");
                svg.appendChild(c);
            };
            makeCircle(15.9, "25", "#222");
            makeCircle(6.35, "BULL", "#333");
            container.appendChild(svg);
        }
    </script>
</body>
</html>